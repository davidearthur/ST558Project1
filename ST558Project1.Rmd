---
title: "ST558 Project 1"
author: "David Arthur"
date: "6/14/2021"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(httr)
library(jsonlite)
```

Function to get Team ID when name is input
```{r}
franchiseInfo <- GET("https://records.nhl.com/site/api/franchise") %>% 
  content("text") %>% 
  fromJSON(flatten = TRUE)

teamNameIdMatch <- franchiseInfo$data %>% select(mostRecentTeamId, fullName, teamAbbrev)

getTeamId <- function(team){
  Id <- teamNameIdMatch %>% filter(str_detect(fullName, team)) %>%
    select(mostRecentTeamId)
  if (nrow(Id) == 1){
    return(as.numeric(Id))
  } else {
    stop("try again entering team name or ID")
  }
}
```

## Records API functions
```{r}
recordsBaseUrl <- "https://records.nhl.com/site/api"

nhltest <- GET("https://records.nhl.com/site/api/draft?cayenneExp=draftYear=2017%20and%20draftedByTeamId=15%20and%20roundNumber!=4") %>% content("text") %>% fromJSON(flatten = TRUE)
nhltest$data$roundNumber

fullUrl <- paste0(recordsBaseUrl, "/draft?cayenneExp=draftedByTeamId=", team)
nhltest2 <- GET(fullUrl) %>% content("text") %>% fromJSON(flatten = TRUE)

FranchiseInfoTest <- GET("https://records.nhl.com/site/api/franchise?cayenneEsp=teamAbbrev=MTL") %>% content("text") %>% fromJSON(flatten = TRUE)
FranchiseInfoTest$data %>% arrange(fullName)


```




```{r}
getFranchiseInfo <- function(team){
  if(!is.numeric(team)) getTeamId(team)
  fullUrl <- paste0(recordsBaseUrl, "/franchise?cayenneEsp=mostRecentTeamId=", team)
  GET(fullUrl) %>% content("text") %>% fromJSON(flatten = TRUE)
}

team <- 12
getSeasonRecords <- function(team){
  if(!is.numeric(team)) getTeamId(team)
  fullURL <- paste0(recordsBaseUrl, "/franchise-season-records?cayenneEsp=FranchiseId=", team)
  test <- GET(fullURL) %>% content("text") %>% fromJSON(flatten = TRUE) %>% as.data.frame()
}
test
get
test$data$franchiseId

getSeasonRecords(12)
GoalieRecords <- GET("https://records.nhl.com/site/api/franchise-goalie-records?cayenneEsp=id=235") %>% content("text") %>% fromJSON(flatten = TRUE)
GoalieRecords$data

```


##Stats API function
```{r Stats API}
testStats2 <- GET("https://statsapi.web.nhl.com/api/v1/teams?expand=team.stats") %>%
  content("text") %>%
  fromJSON(flatten = TRUE) %>%
  as.data.frame()

getStats <- function(team = NULL){
  if(is.null(team)){
    teamStats <- GET("https://statsapi.web.nhl.com/api/v1/teams?expand=team.stats") %>%
    content("text") %>%
    fromJSON(flatten = TRUE) %>%
    as.data.frame()
    allTeams <- data.frame()
    for (i in seq_along(teamStats$teams.id)){
      allTeams <- bind_rows(df, teamStats[[9]][[i]][[1]][[1]])
    }
    allTeams <- allTeams %>% relocate(starts_with("team"))
    return(allTeams)
  } else{
    if(!is.numeric(team)) {team <- getTeamId(team)}
    fullURL <- paste0("https://statsapi.web.nhl.com/api/v1/teams", "/", team, "?expand=team.stats")
    teamStats <- GET(fullURL) %>%
      content("text") %>%
      fromJSON(flatten = TRUE) %>%
      as.data.frame()
    oneTeam <- teamStats[[9]][[1]][[1]][[1]] %>%
      relocate(starts_with("team"))
    return(oneTeam)
  }
}

getStats()
str(getStats(team = "Hurricanes"))
str(getStats())
getStats(team = "Ducks")
getStats()

getTeamId("Canadiens")



#for stats without rankings
str(testStats2[[9]][[11]][[1]][[1]][1,]) %>%
  relocate(starts_with("team"))
```

## Wrapper function